<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAL Tutoring</title>
    <style>
        body { font-family: Arial, sans-serif; display: flex; height: 100vh; margin: 0; background-color: #f4f4f4; }
        #left-panel { width: 250px; background-color: #333; color: white; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        #left-panel h3 { margin-top: 0; color: #61dafb; }
        #audio-list ul { list-style: none; padding: 0; }
        #audio-list li { padding: 10px; cursor: pointer; border-bottom: 1px solid #555; transition: background-color 0.2s; }
        #audio-list li:hover { background-color: #555; }
        #audio-list li.selected { background-color: #61dafb; color: #333; font-weight: bold; }

        #main-content { flex-grow: 1; padding: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #audio-player-container { text-align: center; margin-bottom: 30px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 80%; max-width: 800px; }
        audio { width: 100%; margin-top: 10px; }
        #controls { margin-top: 15px; }
        #controls button { padding: 10px 20px; font-size: 1em; margin: 0 5px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; transition: background-color 0.2s; }
        #controls button:hover { background-color: #0056b3; }
        #controls button:disabled { background-color: #cccccc; cursor: not-allowed; }
		#edit-toggle-container { margin: 0 15px; display: flex; align-items: center; }
        #edit-toggle-container label { margin-left: 5px; font-weight: bold; color: #333; }

        #timestamp-container { width: 80%; max-width: 800px; background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto; max-height: 400px; }
        #timestamp-list { list-style: none; padding: 0; }
        #timestamp-list li { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        #timestamp-list li span { cursor: pointer; color: #007bff; transition: color 0.2s; }
        #timestamp-list li span:hover { color: #0056b3; text-decoration: underline; }
		#timestamp-list li button.script-toggle-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; padding: 0.2em 0.5em; transition: color 0.2s; line-height: 1; margin-right: 15px; }
		#timestamp-list li button.script-toggle-btn::before { content: 'üò£'; }
		#timestamp-list li button.script-toggle-btn.active::before { content: 'üòÉ'; }
		#timestamp-list li textarea.script-input, #timestamp-list li div.script-display { padding: 5px; border-radius: 2px; width: 70%; color: #222222; margin-left: 15px; overflow-wrap: break-word; font-size: 1rem; }
		#timestamp-list li textarea.script-input { border: 1px solid #ccc; display: block; resize: none; }
		#timestamp-list li div.script-display.hide { background-color: #222222; }
        #timestamp-list li button.delete-btn { background-color: #dc3545; color: white; border: none; border-radius: 3px; padding: 4px 8px; cursor: pointer; font-size: 0.8em; transition: background-color 0.2s; }
        #timestamp-list li button.delete-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>
    <div id="left-panel">
        <h3>Audio Files</h3>
        <ul id="audio-list">
            </ul>
    </div>

    <div id="main-content">
        <div id="audio-player-container">
            <h2><span id="current-audio-title"></span></h2>
            <audio id="audioPlayer" controls preload="auto"></audio>
            <div id="controls">
				<button id="playBtn">Play</button>
                <button id="pauseBtn">Pause</button>
				<div id="edit-toggle-container">
                    <input type="checkbox" id="editCheckbox">
                    <label for="editCheckbox">Edit</label>
                </div>
            </div>
        </div>

        <div id="timestamp-container">
            <h3>Timestamps</h3>
            <ul id="timestamp-list"></ul>
        </div>
    </div>

	<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
		// Your web app's Firebase configuration
		// For Firebase JS SDK v7.20.0 and later, measurementId is optional
		const firebaseConfig = {
		  apiKey: "AIzaSyBbYOYs8vUUij8GFKWBzJ0UKt1tmi1E1yU",
		  authDomain: "ealtutoring.firebaseapp.com",
		  databaseURL: "https://ealtutoring-default-rtdb.firebaseio.com",
		  projectId: "ealtutoring",
		  storageBucket: "ealtutoring.firebasestorage.app",
		  messagingSenderId: "559694690544",
		  appId: "1:559694690544:web:e9996582840c22baeaea35",
		  measurementId: "G-DR02FCCDK9"
		};

        // Firebase Ï¥àÍ∏∞Ìôî
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>
    <script>
		// Firebase Realtime Database Ï∞∏Ï°∞
		const database = firebase.database();
		const firebaseRef = database.ref('eal_tutoring');
		let actionIndex = 0;

        const audioPlayer = document.getElementById('audioPlayer');
		const playBtn = document.getElementById('playBtn');
        const pauseBtn = document.getElementById('pauseBtn');
		const editCheckbox = document.getElementById('editCheckbox');
		const timestampContainer = document.getElementById('timestamp-container');
        const timestampList = document.getElementById('timestamp-list');
        const audioList = document.getElementById('audio-list');
        const currentAudioTitle = document.getElementById('current-audio-title');
		let segmentEndTime = -1
		
		let currentAudioId = '';
        let currentAudioSrc = '';
        let currentTimestamps = []; // ÌòÑÏû¨ Ïò§ÎîîÏò§ ÌååÏùºÏùò ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑÎ•º Ï†ÄÏû•Ìï† Î∞∞Ïó¥
		
        // Ïò§ÎîîÏò§ ÌååÏùº Î™©Î°ù
        const audioFiles = [
            { id: 'audio1', title: 'The Assembly', src: 'audios/The Assembly.mp3' },
            { id: 'audio2', title: 'Orphan Black 2', src: 'audios/Orphan Black 2.mp3' },
            { id: 'audio3', title: 'Orphan Black 3', src: 'audios/Orphan Black 3.mp3' },
			/*
			{ id: 'audio4', title: 'Kim\'s Convenience 1', src: 'audios/Kim\'s Convenience 1.mp3' },
            { id: 'audio5', title: 'Kim\'s Convenience 2', src: 'audios/Kim\'s Convenience 2.mp3' },
            { id: 'audio6', title: 'Kim\'s Convenience 3', src: 'audios/Kim\'s Convenience 3.mp3' },
			{ id: 'audio7', title: 'Heartland 1', src: 'audios/Heartland 1.mp3' },
            { id: 'audio8', title: 'Heartland 2', src: 'audios/Heartland 2.mp3' },
            { id: 'audio9', title: 'Heartland 3', src: 'audios/Heartland 3.mp3' },
			{ id: 'audio10', title: 'Schitt\'s Creek 1', src: 'audios/Schitt\'s Creek 1.mp3' },
            { id: 'audio11', title: 'Schitt\'s Creek 2', src: 'audios/Schitt\'s Creek 2.mp3' },
            { id: 'audio12', title: 'Schitt\'s Creek 3', src: 'audios/Schitt\'s Creek 3.mp3' },
			{ id: 'audio13', title: 'Murdoch Mysteries 1', src: 'audios/Murdoch Mysteries 1.mp3' },
            { id: 'audio14', title: 'Murdoch Mysteries 2', src: 'audios/Murdoch Mysteries 2.mp3' },
            { id: 'audio15', title: 'Murdoch Mysteries 3', src: 'audios/Murdoch Mysteries 3.mp3' },
			{ id: 'audio16', title: 'Anne with an E 1', src: 'audios/Anne with an E 1.mp3' },
            { id: 'audio17', title: 'Anne with an E 2', src: 'audios/Anne with an E 2.mp3' },
            { id: 'audio18', title: 'Anne with an E 3', src: 'audios/Anne with an E 3.mp3' },
			*/
        ];
		
		function saveTimestamps(){
			firebaseRef.child(currentAudioId).set(currentTimestamps);
			const action = {
				index: actionIndex++,
				type: "save",
				timestamps: currentTimestamps
			}
			firebaseRef.child("action").set(action);
		}
		
		function syncPartialTimestamp(index, attr, value){
			firebaseRef.child(currentAudioId).child(index.toString()).child(attr).set(value);
			const action = {
				index: actionIndex++,
				type: "sync",
				index: index,
				attr: attr,
				value: value
			}
			firebaseRef.child("action").set(action);
		}
		
		function loadNotice(){
			const action = {
				index: actionIndex++,
				type: "load",
				audioId: currentAudioId
			}
			firebaseRef.child("action").set(action);
			firebaseRef.child("audioId").set(currentAudioId);
		}

		function play(){
			const action = {
				index: actionIndex++,
				type: "play",
				startTime: audioPlayer.currentTime,
				endTime: segmentEndTime
			}
			firebaseRef.child("action").set(action);
		}

		function pause(){
			const action = {
				index: actionIndex++,
				type: "pause"
			}
			firebaseRef.child("action").set(action);
		}

        // Ïò§ÎîîÏò§ Î™©Î°ù Î†åÎçîÎßÅ
        function renderAudioList() {
            audioList.innerHTML = '';
            audioFiles.forEach(file => {
                const li = document.createElement('li');
                li.dataset.id = file.id;
                li.textContent = file.title;
                li.addEventListener('click', () => {
					selectAudio(file);
					loadNotice();
				});
                audioList.appendChild(li);
            });
        }
		
        // Ïò§ÎîîÏò§ ÏÑ†ÌÉù Î∞è Î°úÎìú
        function selectAudio(file) {
			// ÏÑ†ÌÉùÎêú Ïò§ÎîîÏò§ ÌëúÏãú
            document.querySelectorAll('#audio-list li').forEach(item => {
                item.classList.remove('selected');
                if (item.dataset.id === file.id) {
                    item.classList.add('selected');
                }
            });

			segmentEndTime = -1
			currentAudioId = file.id;
            currentAudioSrc = file.src;
            currentAudioTitle.textContent = file.title;
            audioPlayer.src = currentAudioSrc;
            audioPlayer.load(); // Ïò§ÎîîÏò§ Î°úÎìú
			
            // Ïù¥Ï†ÑÏóê Ï†ÄÏû•Îêú ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Î∂àÎü¨Ïò§Í∏∞
			firebaseRef.once('value').then((snapshot) => {
				const data = snapshot.val();
				const storedTimestamps = data ? data[currentAudioId] : null;
				currentTimestamps = storedTimestamps ? storedTimestamps : [];
				segmentEndTime = currentTimestamps ? (currentTimestamps[0] ? currentTimestamps[0].time : -1) : -1;
				renderTimestamps();
			});
        }

        // ÏãúÍ∞Ñ Ìè¨Îß∑ÌåÖ (HH:MM:SS)
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);
            return [h, m, s]
                .map(v => v < 10 ? '0' + v : v)
                .filter((v, i) => v !== '00' || i > 0 || h > 0) // ÏãúÍ∞Ñ Î∂ÄÎ∂ÑÏù¥ 00Ïù¥Î©¥ Ïà®ÍπÄ (hÍ∞Ä 0Ïùº Í≤ΩÏö∞)
                .join(':');
        }
		
        // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä Ìï®Ïàò
        function addTimestamp(time) {
			const timestamp = {
				time: time,
				script: "",
				isScriptVisible: true
			}
            currentTimestamps.push(timestamp);
            currentTimestamps.sort((a, b) => a.time - b.time); // ÏãúÍ∞Ñ ÏàúÏÑúÎåÄÎ°ú Ï†ïÎ†¨
            renderTimestamps();
			saveTimestamps();
        }
		
		// ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ ÏÇ≠Ï†ú
        function deleteTimestamp(index) {
            currentTimestamps.splice(index, 1);
			if (!currentTimestamps) currentTimestamps = [];
            renderTimestamps();
			saveTimestamps();
        }
		
		function autoResizeTextarea(element) {
			element.style.height = 'auto'; 
			element.style.height = element.scrollHeight + 'px';
		}
		
		function saveScriptChanges(index, script){
			currentTimestamps[index].script = script;
		}

        // ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Î†åÎçîÎßÅ
        function renderTimestamps() {
			const originalScroll = timestampContainer.scrollTop;
			console.log(originalScroll);
			timestampList.innerHTML = '';
			const isEditMode = editCheckbox.checked;

			currentTimestamps.forEach((ts, index) => {
				const li = document.createElement('li');
				li.classList.add('timestamp-item');

                const timeSpan = document.createElement('span');
                timeSpan.textContent = formatTime(ts.time);
                timeSpan.dataset.time = ts.time;
                timeSpan.addEventListener('click', () => playSegment(index));
				
				let scriptElement;
				if (isEditMode) {
					scriptElement = document.createElement('textarea');
					scriptElement.type = 'text';
					scriptElement.value = ts.script;
					scriptElement.classList.add('script-input');
					scriptElement.addEventListener('input', function() {
						autoResizeTextarea(this);
						saveScriptChanges(index, this.value); 
					});
				} else {
					scriptElement = document.createElement('div');
					scriptElement.textContent = ts.script;
					scriptElement.classList.add('script-display');
				}
				
				const toggleBtn = document.createElement('button');
				toggleBtn.classList.add('script-toggle-btn');
				
				if (!ts.isScriptVisible){
					scriptElement.classList.add('hide');
				}
				else{
					toggleBtn.classList.add('active');
				}
				
				toggleBtn.addEventListener('click', () => {
					const isVisible = !scriptElement.classList.contains('hide');
					if (isVisible) {
						scriptElement.classList.add('hide');
						toggleBtn.classList.remove('active'); // Ïä§ÌÅ¨Î¶ΩÌä∏ Ïà®ÍπÄ = Îàà Í∞êÏùå
						currentTimestamps[index].isScriptVisible = false;
						syncPartialTimestamp(index, 'isScriptVisible', false);
					} else {
						scriptElement.classList.remove('hide');
						toggleBtn.classList.add('active'); // Ïä§ÌÅ¨Î¶ΩÌä∏ ÌëúÏãú = Îàà Îú∏
						currentTimestamps[index].isScriptVisible = true;
						syncPartialTimestamp(index, 'isScriptVisible', true);
					}
					
				});

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'X';
                deleteBtn.classList.add('delete-btn');
                deleteBtn.addEventListener('click', () => deleteTimestamp(index));

                li.appendChild(timeSpan);
				li.appendChild(scriptElement);
				li.appendChild(toggleBtn);
                li.appendChild(deleteBtn);
                timestampList.appendChild(li);
				
				autoResizeTextarea(scriptElement);
			});
			
			timestampContainer.scrollTop = originalScroll;
		}
		
		function playSegment(index) {
            const startTime = currentTimestamps[index].time;
            const endTime = currentTimestamps[index + 1] ? currentTimestamps[index + 1].time : -1;

            audioPlayer.currentTime = startTime;
			segmentEndTime = endTime;
            play();
        }
        
		audioPlayer.addEventListener('timeupdate', () => {
            if (segmentEndTime !== -1 && audioPlayer.currentTime >= segmentEndTime) {
                audioPlayer.pause();
				const nextGreater = currentTimestamps.find(ts => ts.time > segmentEndTime);
				if (nextGreater) segmentEndTime = nextGreater;
				else segmentEndTime = -1;
            }
        });

        playBtn.addEventListener('click', () => {
			play();
        });
		
        pauseBtn.addEventListener('click', () => {
            addTimestamp(audioPlayer.currentTime);
			pause();
        });
		
		editCheckbox.addEventListener('change', function() {
			renderTimestamps();
			if (!this.checked) saveTimestamps();
		});
		
		function syncPlay(action){
			audioPlayer.currentTime = action.startTime;
			segmentEndTime = action.endTime;
            audioPlayer.play();
		}
		
		function syncPause(){
			audioPlayer.pause();
		}
		
		function syncTimestamps(timestamps){
			currentTimestamps = timestamps;
			renderTimestamps()
		}
		
		function syncTimestamp(index, attr, value){
			currentTimestamps[index][attr] = value;
			renderTimestamps()
		}
		
		function syncFile(id){
			for (const file of audioFiles) {
				if (file.id != id) continue;
				selectAudio(file);
				break;
			}
		}

        // Ï¥àÍ∏∞ Î†åÎçîÎßÅ
        renderAudioList();

		// Ï¥àÍ∏∞Ìôî
		firebaseRef.once('value').then((snapshot) => {
			const data = snapshot.val();
			if (!data.audioId) {
				return;
			}
			syncFile(data.audioId);
			syncTimestamps(data[data.audioId]);
		});
		
		// ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ Îê† ÎïåÎßàÎã§ Ìò∏Ï∂ú
		firebaseRef.child('action').on('value', (snapshot) => {
			const action = snapshot.val();
			if (action.type === 'play') syncPlay(action);
			else if (action.type === 'pause') syncPause();
			else if (action.type === 'load') syncFile(action.audioId);
			else if (action.type === 'save') syncTimestamps(action.timestamps);
			else if (action.type === 'sync') syncTimestamp(action.index, action.attr, action.value);
		}, (error) => {
        	console.error("Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî Ïò§Î•ò:", error);
    	});
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tutee Workspace</title>
    <script src="https://unpkg.com/diff-match-patch@1.0.5/index.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f5f7fb; --ins: #e6ffec; --del: #ffebe9; --del-text: #cf222e; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        
        .left-panel { width: 40%; height: 100vh; padding: 30px; border-right: 1px solid #ddd; background: #fff; }
        .right-panel { width: 60%; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        
        h2 { font-size: 1.2rem; margin-bottom: 10px; color: #555; }
        .display-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e0e0e0; line-height: 1.7; white-space: pre-wrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        textarea { width: 90%; height: 200px; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; font-size: 1rem; outline: none; }
        
        /* Diff Styles */
        .highlight-del { background-color: var(--del); color: var(--del-text); text-decoration: line-through; padding: 2px 0; }
        .highlight-ins { background-color: var(--ins); border-bottom: 2px solid #2da44e; padding: 2px 0; }
    </style>
</head>
<body>
    <div class="left-panel">
        <h2 style="color: var(--primary);">Lesson Passage</h2>
        <div id="passageDisplay" class="display-box" style="height: 80vh;">Waiting...</div>
    </div>

    <div class="right-panel">
        <div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
				<h2>Your Writing</h2>
				<span id="charCount" style="font-size: 0.9rem; color: #4a90e2; font-weight: bold; margin-bottom: 10px; margin-right: 5%;">0</span>
			</div>
            <textarea id="studentInput" oninput="updateWriting()" placeholder="Write here..."></textarea>
        </div>
        <div>
            <h2>Live Feedback</h2>
            <div id="feedbackDisplay" class="display-box" style="min-height: 200px; width: 90%;">Waiting...</div>
        </div>
    </div>

	<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
			  apiKey: "AIzaSyBbYOYs8vUUij8GFKWBzJ0UKt1tmi1E1yU",
			  authDomain: "ealtutoring.firebaseapp.com",
			  databaseURL: "https://ealtutoring-default-rtdb.firebaseio.com",
			  projectId: "ealtutoring",
			  storageBucket: "ealtutoring.firebasestorage.app",
			  messagingSenderId: "559694690544",
			  appId: "1:559694690544:web:e9996582840c22baeaea35",
			  measurementId: "G-DR02FCCDK9"
			};

        // Firebase 초기화
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
		const database = firebase.database();
		const firebaseRef = database.ref('eal_tutoring');

        let currentWriting = "";
		
		function countWords(text) {
			if (!text || text.trim() === "") return 0;
			return text.trim().split(/\s+/).length;
		}
		
		// 지문 업데이트
		firebaseRef.child('passage').on('value', (snapshot) => {
			document.getElementById('passageDisplay').innerText = snapshot.val()
		}, (error) => {
        	console.error("실시간 동기화 오류:", error);
    	});
		
		// 피드백 업데이트
		firebaseRef.child('feedback').on('value', (snapshot) => {
			showDiff(currentWriting, snapshot.val());
		}, (error) => {
        	console.error("실시간 동기화 오류:", error);
    	});
		

        // 내 작문 DB 전송
        function updateWriting() {
            const text = document.getElementById('studentInput').value;
            currentWriting = text;
			document.getElementById('charCount').innerText = `${countWords(text)}`;
			firebaseRef.child("writing").set(text);
        }

        // 변경 사항 비교 (Diff) 함수
        function showDiff(oldText, newText) {
            const dmp = new diff_match_patch();
            const diffs = dmp.diff_main(oldText, newText);
            dmp.diff_cleanupSemantic(diffs);

            let html = "";
            diffs.forEach((part) => {
                const type = part[0]; // 0: 유지, 1: 추가, -1: 삭제
                const text = part[1];
                if (type === 1) html += `<span class="highlight-ins">${text}</span>`;
                else if (type === -1) html += `<span class="highlight-del">${text}</span>`;
                else html += text;
            });
            document.getElementById('feedbackDisplay').innerHTML = html;
        }
    </script>
</body>
</html>
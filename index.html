<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tutee Workspace</title>
    <script src="https://unpkg.com/diff-match-patch@1.0.5/index.js"></script>
    <style>
        :root { --primary: #4a90e2; --bg: #f5f7fb; --ins: #e6ffec; --del: #ffebe9; --del-text: #cf222e; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; }
        
        .left-panel { width: 40%; height: 100vh; padding: 30px; border-right: 1px solid #ddd; background: #fff; }
        .right-panel { width: 60%; padding: 30px; display: flex; flex-direction: column; gap: 20px; }
        
        h2 { font-size: 1.2rem; margin-bottom: 10px; color: #555; }
        .display-box { background: white; border-radius: 12px; padding: 20px; border: 1px solid #e0e0e0; line-height: 1.7; white-space: pre-wrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        textarea { width: 90%; height: 200px; border: 2px solid var(--primary); border-radius: 12px; padding: 15px; font-size: 1rem; outline: none; }
		textarea:disabled { border: none !important; }
        
        /* Diff Styles */
        .highlight-del { background-color: var(--del); color: var(--del-text); text-decoration: line-through; padding: 2px 0; }
        .highlight-ins { background-color: var(--ins); border-bottom: 2px solid #2da44e; padding: 2px 0; }
		
		// HIW
		.word { cursor: pointer; user-select: none; padding: 2px 4px; border-radius: 4px; transition: 0.2s; border-bottom: 2px solid transparent; }
		.word:hover { background-color: #eee; }
		.word.selected { background-color: #fff59d; border-bottom: 2px solid #ffd600; font-weight: bold; }
    </style>
</head>
<body>
    <div class="left-panel">
        <h2 style="color: var(--primary);">Lesson Passage</h2>
        <div id="passageDisplay" class="display-box" style="height: 80vh;">Waiting...</div>
    </div>

    <div class="right-panel">
        <div>
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
				<h2>Your Writing</h2>
				<span id="charCount" style="font-size: 0.9rem; color: #4a90e2; font-weight: bold; margin-bottom: 10px; margin-right: 5%;">0</span>
			</div>
            <textarea id="studentInput" oninput="updateWriting()"></textarea>
        </div>
        <div>
            <h2>Live Feedback</h2>
            <div id="feedbackDisplay" class="display-box" style="min-height: 200px; width: 90%;">Waiting...</div>
        </div>
    </div>

	<script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        const firebaseConfig = {
			  apiKey: "AIzaSyBbYOYs8vUUij8GFKWBzJ0UKt1tmi1E1yU",
			  authDomain: "ealtutoring.firebaseapp.com",
			  databaseURL: "https://ealtutoring-default-rtdb.firebaseio.com",
			  projectId: "ealtutoring",
			  storageBucket: "ealtutoring.firebasestorage.app",
			  messagingSenderId: "559694690544",
			  appId: "1:559694690544:web:e9996582840c22baeaea35",
			  measurementId: "G-DR02FCCDK9"
			};

        // Firebase 초기화
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
		const database = firebase.database();
		const firebaseRef = database.ref('eal_tutoring');

        let currentWriting = "";
		let mode = "writing";
		
		function countWords(text) {
			if (!text || text.trim() === "") return 0;
			return text.trim().split(/\s+/).length;
		}
		
		// 지문 업데이트
		firebaseRef.child('passage').on('value', (snapshot) => {
			if (mode === 'fib') {
				renderFIB(snapshot.val());
			} else if (mode === 'hiw') {
				renderHIW(snapshot.val());
			} else {
				document.getElementById('passageDisplay').innerText = snapshot.val();
			}
		}, (error) => {
        	console.error("실시간 동기화 오류:", error);
    	});
		
		function updateFIBInputsFromTutor(text) {
			const answers = text.split(' | ');
			
			answers.forEach((val, i) => {
				const input = document.getElementById('i' + i);
				if (input) input.value = val.trim();
			});
		}
		
		function updateTuteeHighlights(data) {
			const allWords = document.querySelectorAll('.word');
			allWords.forEach(word => word.classList.remove('selected'));

			if (data && data.trim() !== "") {
				const indices = data.split(' | ');

				indices.forEach(idx => {
					const targetWord = document.getElementById('word-' + idx.trim());
					if (targetWord) {
						targetWord.classList.add('selected');
					}
				});
			}
		}
		
		// 피드백 업데이트
		firebaseRef.child('feedback').on('value', (snapshot) => {
			const feedback = snapshot.val();
			if (mode === 'fib') {
				updateFIBInputsFromTutor(feedback);
			} else if (mode === 'hiw') {
				updateTuteeHighlights(feedback);
			} else {
				showDiff(currentWriting, feedback);
			}
		}, (error) => {
        	console.error("실시간 동기화 오류:", error);
    	});
		
		
		// 모드 업데이트
		firebaseRef.child('mode').on('value', (snapshot) => {
			mode = snapshot.val();
						
			const studentInput = document.getElementById('studentInput');
			const feedbackDisplay = document.getElementById('feedbackDisplay');
			
			if (mode === 'fib' || mode === 'hiw') {
				studentInput.placeholder = "-";
				studentInput.disabled = true;
				feedbackDisplay.style.visibility = 'hidden';
			} else {
				studentInput.placeholder = "Write here...";
				studentInput.disabled = false;
				feedbackDisplay.style.visibility = 'visible';
			}
			
			currentWriting = '';
			document.getElementById('passageDisplay').innerText = '';
			studentInput.innerText = '';
			feedbackDisplay.innerHTML = '';
		}, (error) => {
        	console.error("실시간 동기화 오류:", error);
    	});

        // 내 작문 DB 전송
        function updateWriting() {
            const text = document.getElementById('studentInput').value;
            currentWriting = text;
			document.getElementById('charCount').innerText = `${countWords(text)}`;
			firebaseRef.child("writing").set(text);
        }

        // 변경 사항 비교 (Diff) 함수
        function showDiff(oldText, newText) {
            const dmp = new diff_match_patch();
            const diffs = dmp.diff_main(oldText, newText);
            dmp.diff_cleanupSemantic(diffs);

            let html = "";
            diffs.forEach((part) => {
                const type = part[0]; // 0: 유지, 1: 추가, -1: 삭제
                const text = part[1];
                if (type === 1) html += `<span class="highlight-ins">${text}</span>`;
                else if (type === -1) html += `<span class="highlight-del">${text}</span>`;
                else html += text;
            });
            document.getElementById('feedbackDisplay').innerHTML = html;
        }
		
		function updateFibWriting(totalInputs) {
			let answers = [];
			
			for (let i = 0; i < totalInputs; i++) {
				const inputElement = document.getElementById('i' + i);
				if (inputElement) {
					answers.push(inputElement.value || " "); 
				}
			}

			currentWriting = answers.join(' | ');
			firebaseRef.child("writing").set(currentWriting);
		}
		
		function renderFIB(text) {
			const container = document.getElementById('passageDisplay');
			const parts = text.split('[]');
			container.innerHTML = ''; // 초기화

			parts.forEach((part, i) => {
				// 텍스트 부분 추가
				container.appendChild(document.createTextNode(part));

				// 마지막 파트가 아니라면 input 생성
				if (i < parts.length - 1) {
					const input = document.createElement('input');
					input.type = 'text';
					input.className = 'fib-input';
					input.id = 'i' + i;
					
					input.oninput = () => {
						updateFibWriting(parts.length - 1);
					};

					container.appendChild(input);
				}
			});
		}
		
		function renderHIW(text) {
			const container = document.getElementById('passageDisplay');
			const words = text.split(/(\n|\s+)/); 
			container.innerHTML = '';

			words.forEach((word, i) => {
				if (word === '\n') {
					container.appendChild(document.createElement('br'));
				} else if (word.trim() === '') {
					container.appendChild(document.createTextNode(' '));
				} else {
					const span = document.createElement('span');
					span.innerText = word;
					span.className = 'word';
					span.id = 'word-' + i;

					span.onclick = () => {
						span.classList.toggle('selected');
						updateHiwWriting();
					};

					container.appendChild(span);
				}
			});
		}
		
		function updateHiwWriting() {
			const selectedElements = document.querySelectorAll('.word.selected');
			const indices = Array.from(selectedElements).map(el => el.id.replace('word-', ''));
			
			const combinedIndices = indices.join(' | ');
			
			firebaseRef.child("writing").set(combinedIndices);
		}
    </script>
</body>
</html>